<!DOCTYPE
html >
  <html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel ="icon" type="image/png" href="../static/cerebro.png">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>AI4Teach - Entrenamiento</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #185d96;
        }
        .logo img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .training-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .section-title {
            color: #185d96;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        select.form-control {
            background-color: white;
        }
        .btn {
            background-color: #185d96;
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #164e7c;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .file-upload {
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }
        .file-upload input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            cursor: pointer;
            display: block;
        }
        .file-upload-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .file-name {
            margin-left: 10px;
            font-style: italic;
        }
        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .augmentation-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group input {
            margin-right: 10px;
        }
        .metrics-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .metrics-title {
            margin-top: 0;
            color: #185d96;
            margin-bottom: 15px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .metric-card {
            background-color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #185d96;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        .progress-container {
            margin: 20px 0;
        }
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #185d96;
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            margin-top: 5px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            flex: 1;
            min-width: 300px;
            height: 300px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 15px;
        }
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            color: #185d96;
            margin-bottom: 10px;
            text-align: left;
        }
        .inference-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: none;
        }
        .inference-title {
            margin-top: 0;
            color: #185d96;
            margin-bottom: 15px;
        }
        .inference-input {
            margin-bottom: 20px;
        }
        .inference-results {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            background-color: #f8f9fa;
        }
        .tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom-color: white;
            margin-bottom: -1px;
            color: #185d96;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .data-source-selector {
            margin-bottom: 15px;
        }
        .data-source-option {
            margin-right: 15px;
        }
        .data-source-content {
            margin-top: 15px;
            display: none;
        }
        .data-source-content.active {
            display: block;
        }
        .optgroup-select {
            font-weight: bold;
            color: #185d96;
        }
        .action-buttons {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
        }

        .action-buttons .btn {
            margin-bottom: 10px;
            flex: 0 1 auto;
        }

        @media (max-width: 768px) {
            .action-buttons {
                justify-content: center;
            }
            
            .action-buttons .btn {
                flex: 1 1 calc(50% - 10px);
                max-width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                padding: 12px 10px;
            }
        }

        @media (max-width: 480px) {
            .action-buttons .btn {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <a style="text-decoration: none; color: inherit;" href="home">AI4Teach</a>
        </div>
        <div class="user-info">
            <span id="username">Usuario</span>
        </div>
    </header>

    <div class="container">
        <div class="training-container">
            <h1 class="section-title">Entrenamiento de Modelo</h1>
            
            <div class="tabs">
                <div class="tab active" data-tab="setup">Configuración</div>
                <div class="tab" data-tab="training">Entrenamiento</div>
                <div class="tab" data-tab="inference">Inferencia</div>
            </div>
            
            <!-- Pestaña de Configuración -->
            <div class="tab-content active" id="setup-tab">
                <!-- Selección de Modelo -->
                <div class="form-group">
                    <label for="model-select">Seleccionar Modelo:</label>
                    <select id="model-select" class="form-control">
                        <option value="">-- Seleccione un modelo --</option>
                        <optgroup label="Imagen">
                            <option value="image-resnet50">ResNet-50</option>
                            <option value="image-vgg16">VGG-16</option>
                            <option value="image-mobilenet">MobileNet</option>
                            <option value="image-efficientnet">EfficientNet</option>
                            <option value="image-yolo">YOLO v5</option>
                        </optgroup>
                        <optgroup label="Texto">
                            <option value="text-bert">BERT</option>
                            <option value="text-gpt2">GPT-2</option>
                            <option value="text-roberta">RoBERTa</option>
                            <option value="text-t5">T5</option>
                        </optgroup>
                        <optgroup label="Audio">
                            <option value="audio-wavenet">WaveNet</option>
                            <option value="audio-deepspeech">DeepSpeech</option>
                            <option value="audio-whisper">Whisper</option>
                        </optgroup>
                        <optgroup label="Video">
                            <option value="video-c3d">C3D</option>
                            <option value="video-i3d">I3D</option>
                            <option value="video-slowfast">SlowFast</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Carga de Datos -->
                <div class="form-group">
                    <label>Conjunto de Datos:</label>
                    
                    <div class="data-source-selector">
                        <label class="data-source-option">
                            <input type="radio" name="data-source" value="server" checked> Seleccionar del servidor
                        </label>
                        <label class="data-source-option">
                            <input type="radio" name="data-source" value="upload"> Cargar archivo
                        </label>
                    </div>
                    
                    <!-- Opción: Seleccionar del servidor -->
                    <div id="server-data-source" class="data-source-content active">
                        <select id="server-dataset" class="form-control">
                            <option value="">-- Seleccione un conjunto de datos --</option>
                            <optgroup label="Imagen">
                                <option value="mnist">MNIST (Clasificación)</option>
                                <option value="imagenet">ImageNet (Clasificación)</option>
                                <option value="coco">COCO (Detección)</option>
                                <option value="cifar10">CIFAR-10 (Clasificación)</option>
                                <option value="cifar100">CIFAR-100 (Clasificación)</option>
                            </optgroup>
                            <optgroup label="Texto">
                                <option value="imdb">IMDB Reviews (Sentimiento)</option>
                                <option value="squad">SQuAD (Preguntas y Respuestas)</option>
                                <option value="glue">GLUE (Tareas múltiples)</option>
                            </optgroup>
                            <optgroup label="Audio">
                                <option value="librispeech">LibriSpeech (Reconocimiento)</option>
                                <option value="voxceleb">VoxCeleb (Identificación)</option>
                                <option value="gtzan">GTZAN (Clasificación música)</option>
                            </optgroup>
                            <optgroup label="Video">
                                <option value="ucf101">UCF101 (Acciones)</option>
                                <option value="kinetics">Kinetics-400 (Acciones)</option>
                                <option value="hmdb51">HMDB51 (Acciones)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Opción: Cargar archivo -->
                    <div id="upload-data-source" class="data-source-content">
                        <div style="margin-top: 10px;">
                            <label for="dataset-format">Formato:</label>
                            <select id="dataset-format" class="form-control">
                                <option value="npz">NumPy (.npz)</option>
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                                <option value="images">Imágenes</option>
                                <option value="h5">HDF5 (.h5)</option>
                            </select>
                        </div>
                        
                        <div class="file-upload" style="margin-top: 15px;">
                            <label class="file-upload-label">Seleccionar Archivo</label>
                            <input type="file" id="dataset-upload" accept=".csv,.json,.zip,.h5,.npz">
                            <span class="file-name" id="dataset-filename">Ningún archivo seleccionado</span>
                        </div>
                    </div>
                </div>
                
                <!-- Parámetros de Entrenamiento -->
                <div class="form-group">
                    <label>Parámetros de Entrenamiento:</label>
                    <div class="parameters-grid">
                        <div>
                            <label for="porcentaje-dataset">Porcentaje del Dataset</label>
                            <input type="number" id="porcentaje-dataset" class="form-control" value="100" min="1" max="100">
                        </div>
                        <div>
                            <label for="batch-size">Tamaño de Lote:</label>
                            <input type="number" id="batch-size" class="form-control" value="32" min="1">
                        </div>
                        <div>
                            <label for="epochs">Número de Épocas:</label>
                            <input type="number" id="epochs" class="form-control" value="10" min="1">
                        </div>
                        <div>
                            <label for="optimizer">Optimizador:</label>
                            <select id="optimizer" class="form-control">
                                <option value="adam">Adam</option>
                                <option value="sgd">SGD</option>
                                <option value="rmsprop">RMSprop</option>
                                <option value="adagrad">Adagrad</option>
                            </select>
                        </div>
                        <div>
                            <label for="learning-rate">Tasa de Aprendizaje:</label>
                            <input type="number" id="learning-rate" class="form-control" value="0.001" step="0.0001" min="0">
                        </div>
                        <div>
                            <label for="validation-split">División de Validación (%):</label>
                            <input type="number" id="validation-split" class="form-control" value="20" min="0" max="50">
                        </div>
                        <div>
                            <label for="early-stopping">Parada Temprana:</label>
                            <select id="early-stopping" class="form-control">
                                <option value="yes">Sí</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Aumento de Datos -->
                <div class="form-group">
                    <label>Aumento de Datos:</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-augmentation">
                        <label for="enable-augmentation">Habilitar aumento de datos</label>
                    </div>
                    
                    <div id="augmentation-options" class="augmentation-options" style="margin-top: 15px; display: none;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="aug-flip">
                            <label for="aug-flip">Volteo horizontal</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="aug-rotation">
                            <label for="aug-rotation">Rotación</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="aug-zoom">
                            <label for="aug-zoom">Zoom</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="aug-brightness">
                            <label for="aug-brightness">Brillo</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="aug-contrast">
                            <label for="aug-contrast">Contraste</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="aug-shift">
                            <label for="aug-shift">Desplazamiento</label>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; text-align: right;">
                    <button onclick="sendOptions(), iniciarStream()" id="start-training-btn" class="btn">Iniciar Entrenamiento</button>
                </div>
            </div>
            
            <!-- Pestaña de Entrenamiento -->
            <div class="tab-content" id="training-tab">
                <div class="progress-container">
                    <h3>Progreso del Entrenamiento</h3>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="training-progress"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Época 0/10 - 0%</div>
                </div>
                
                <div class="metrics-container">
                    <h3 class="metrics-title">Métricas de Entrenamiento</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Precisión de Entrenamiento</div>
                            <div class="metric-value" id="train-accuracy">0.00%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Pérdida de Entrenamiento</div>
                            <div class="metric-value" id="train-loss">0.000</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Precisión de Validación</div>
                            <div class="metric-value" id="val-accuracy">0.00%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Pérdida de Validación</div>
                            <div class="metric-value" id="val-loss">0.000</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Precisión de Pruebas</div>
                            <div class="metric-value" id="test-accuracy">0.000</div>
                        </div>
                    </div>
                    
                    <div class="charts-container">
                        <div class="chart-container">
                            <div class="chart-title">Precisión</div>
                            <div id="accuracy-chart"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Pérdida</div>
                            <div id="loss-chart"></div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="downloadJSON(metrics)" class="btn btn-primary">Descargar JSON</button>
                    <button onclick="downloadCSV(metrics)" class="btn btn-primary">Descargar CSV</button>
                    <button onclick="downloadChartImage('accuracy')" class="btn btn-info">Descargar gráfico de precisión</button>
                    <button onclick="downloadChartImage('loss')" class="btn btn-danger">Descargar gráfico de pérdida</button>
                    <button id="stop-training-btn" class="btn btn-secondary">Detener Entrenamiento</button>
                </div>
            </div>
            
            <!-- Pestaña de Inferencia -->
            <div class="tab-content" id="inference-tab">
                <div class="inference-container" id="inference-section">
                    <h3 class="inference-title">Inferencia del Modelo</h3>
                    
                    <div class="inference-input">
                        <label>Datos para Inferencia:</label>
                        <div class="file-upload">
                            <label class="file-upload-label">Seleccionar Archivo</label>
                            <input type="file" id="inference-upload">
                            <span class="file-name" id="inference-filename">Ningún archivo seleccionado</span>
                        </div>
                    </div>
                    
                    <button id="run-inference-btn" class="btn">Ejecutar Inferencia</button>
                    
                    <div class="inference-results" id="inference-results">
                        <h4>Resultados:</h4>
                        <div id="inference-output">
                            Los resultados de la inferencia se mostrarán aquí.
                        </div>
                    </div>
                    
                    <div class="metrics-container">
                        <h3 class="metrics-title">Métricas de Evaluación</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Precisión</div>
                                <div class="metric-value" id="test-accuracy">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Recall</div>
                                <div class="metric-value" id="test-recall">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">F1-Score</div>
                                <div class="metric-value" id="test-f1">0.000</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Tiempo de Inferencia</div>
                                <div class="metric-value" id="inference-time">0 ms</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="no-model-message" style="text-align: center; padding: 50px 0;">
                    <h3 style="color: #666;">No hay ningún modelo entrenado disponible para inferencia</h3>
                    <p>Complete el entrenamiento de un modelo primero.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
            // Variables globales
        let metrics = [];
        let trainingInProgress = false;
        let modelTrained = false;
        let currentEpoch = 0;
        let totalEpochs = 10;
        let trainingInterval;
        let trainingData = {
            accuracy: [],
            loss: [],
            val_accuracy: [],
            val_loss: []
        };
        let trainingCompleted = false; // Nueva variable para controlar si el entrenamiento se completó
        let eventSource = null; // Variable para controlar la conexión SSE

        // Elementos DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const datasetUpload = document.getElementById('dataset-upload');
        const datasetFilename = document.getElementById('dataset-filename');
        const inferenceUpload = document.getElementById('inference-upload');
        const inferenceFilename = document.getElementById('inference-filename');
        const enableAugmentation = document.getElementById('enable-augmentation');
        const augmentationOptions = document.getElementById('augmentation-options');
        const startTrainingBtn = document.getElementById('start-training-btn');
        const stopTrainingBtn = document.getElementById('stop-training-btn');
        const runInferenceBtn = document.getElementById('run-inference-btn');
        const trainingProgress = document.getElementById('training-progress');
        const progressText = document.getElementById('progress-text');
        const inferenceSection = document.getElementById('inference-section');
        const noModelMessage = document.getElementById('no-model-message');
        const dataSourceRadios = document.querySelectorAll('input[name="data-source"]');
        const serverDataSource = document.getElementById('server-data-source');
        const uploadDataSource = document.getElementById('upload-data-source');

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar pestañas
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Activar pestaña
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Mostrar contenido de pestaña
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Manejar selección de fuente de datos
            dataSourceRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'server') {
                        serverDataSource.classList.add('active');
                        uploadDataSource.classList.remove('active');
                    } else {
                        serverDataSource.classList.remove('active');
                        uploadDataSource.classList.add('active');
                    }
                });
            });
            
            // Manejar carga de archivos de conjunto de datos
            datasetUpload.addEventListener('change', function() {
                if (this.files.length > 0) {
                    datasetFilename.textContent = this.files[0].name;
                } else {
                    datasetFilename.textContent = 'Ningún archivo seleccionado';
                }
            });
            
            // Manejar carga de archivos para inferencia
            inferenceUpload.addEventListener('change', function() {
                if (this.files.length > 0) {
                    inferenceFilename.textContent = this.files[0].name;
                } else {
                    inferenceFilename.textContent = 'Ningún archivo seleccionado';
                }
            });
            
            // Manejar opciones de aumento de datos
            enableAugmentation.addEventListener('change', function() {
                augmentationOptions.style.display = this.checked ? 'grid' : 'none';
            });
            
            // Iniciar entrenamiento
            startTrainingBtn.addEventListener('click', sendOptions);
            
            // Detener entrenamiento
            stopTrainingBtn.addEventListener('click', stopTraining);
            
            // Ejecutar inferencia
            runInferenceBtn.addEventListener('click', runInference);
            
            // Filtrar datasets según el modelo seleccionado
            document.getElementById('model-select').addEventListener('change', function() {
                const modelType = this.value.split('-')[0]; // Obtener el tipo (image, text, audio, video)
                const serverDataset = document.getElementById('server-dataset');
                
                // Mostrar todos los optgroups
                Array.from(serverDataset.getElementsByTagName('optgroup')).forEach(optgroup => {
                    optgroup.style.display = '';
                });
                
                // Si se seleccionó un modelo, filtrar los datasets
                if (modelType) {
                    // Mapear el tipo de modelo al label del optgroup
                    const typeToLabel = {
                        'image': 'Imagen',
                        'text': 'Texto',
                        'audio': 'Audio',
                        'video': 'Video'
                    };
                    
                    // Ocultar optgroups que no coincidan con el tipo de modelo
                    Array.from(serverDataset.getElementsByTagName('optgroup')).forEach(optgroup => {
                        if (optgroup.label !== typeToLabel[modelType]) {
                            optgroup.style.display = 'none';
                        }
                    });
                    
                    // Seleccionar el primer dataset del tipo correspondiente
                    const firstOption = Array.from(serverDataset.options).find(option => {
                        return option.parentNode.label === typeToLabel[modelType] && option.value;
                    });
                    
                    if (firstOption) {
                        serverDataset.value = firstOption.value;
                    }
                }
            });

            // Inicializar los gráficos
            initCharts();
            
            // Comprobar parámetros URL
            const params = new URLSearchParams(window.location.search);
            const model = params.get("model");
            if (model) {
                const select = document.getElementById("model-select");
                const option = Array.from(select.options).find(opt => opt.value === model);
                if (option) {
                    option.selected = true;
                    // Disparar el evento change para actualizar los datasets disponibles
                    select.dispatchEvent(new Event('change'));
                }
            }
        });

        // Función para inicializar los gráficos
        function initCharts() {
            // Opciones para el gráfico de precisión
            var accuracyOptions = {
                series: [{
                    name: 'Precisión de Entrenamiento',
                    data: []
                }, {
                    name: 'Precisión de Validación',
                    data: []
                }],
                chart: {
                    height: 250,
                    type: 'line',
                    toolbar: {
                        show: false
                    },
                    animations: {
                        enabled: true,
                        easing: 'linear',
                        dynamicAnimation: {
                            speed: 1000
                        }
                    }
                },
                colors: ['#185d96', '#28a745'],
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                grid: {
                    borderColor: '#e7e7e7',
                    row: {
                        colors: ['#f3f3f3', 'transparent'],
                        opacity: 0.5
                    }
                },
                markers: {
                    size: 3
                },
                xaxis: {
                    categories: [],
                    title: {
                        text: 'Época'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Precisión'
                    },
                    min: 0,
                    max: 1
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    floating: true,
                    offsetY: -25,
                    offsetX: -5
                }
            };

            // Opciones para el gráfico de pérdida
            var lossOptions = {
                series: [{
                    name: 'Pérdida de Entrenamiento',
                    data: []
                }, {
                    name: 'Pérdida de Validación',
                    data: []
                }],
                chart: {
                    height: 250,
                    type: 'line',
                    toolbar: {
                        show: false
                    },
                    animations: {
                        enabled: true,
                        easing: 'linear',
                        dynamicAnimation: {
                            speed: 1000
                        }
                    }
                },
                colors: ['#185d96', '#dc3545'],
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                grid: {
                    borderColor: '#e7e7e7',
                    row: {
                        colors: ['#f3f3f3', 'transparent'],
                        opacity: 0.5
                    }
                },
                markers: {
                    size: 3
                },
                xaxis: {
                    categories: [],
                    title: {
                        text: 'Época'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Pérdida'
                    },
                    min: 0
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    floating: true,
                    offsetY: -25,
                    offsetX: -5
                }
            };

            // Inicializar los gráficos
            window.accuracyChart = new ApexCharts(document.querySelector("#accuracy-chart"), accuracyOptions);
            window.lossChart = new ApexCharts(document.querySelector("#loss-chart"), lossOptions);
            
            // Renderizar los gráficos
            window.accuracyChart.render();
            window.lossChart.render();
        }

        // Función para iniciar entrenamiento
        function startTraining() {
            const modelSelect = document.getElementById('model-select');
            const serverDataset = document.getElementById('server-dataset');
            const dataSource = document.querySelector('input[name="data-source"]:checked').value;
            const epochs = document.getElementById('epochs');
            
            // Validar que se haya seleccionado un modelo
            if (!modelSelect.value) {
                alert('Por favor, seleccione un modelo para entrenar.');
                return;
            }
            
            // Validar que se haya seleccionado o cargado un conjunto de datos
            if (dataSource === 'server' && !serverDataset.value) {
                alert('Por favor, seleccione un conjunto de datos del servidor.');
                return;
            } else if (dataSource === 'upload' && !datasetUpload.files.length) {
                alert('Por favor, cargue un conjunto de datos para el entrenamiento.');
                return;
            }
            
            // Cambiar a la pestaña de entrenamiento
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === 'training') {
                    tab.classList.add('active');
                }
            });
            
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === 'training-tab') {
                    content.classList.add('active');
                }
            });
            
            // Iniciar el entrenamiento real
            trainingInProgress = true;
            trainingCompleted = false; // Reiniciar el estado de completado
            currentEpoch = 0;
            totalEpochs = parseInt(epochs.value);
            
            // Reiniciar datos de entrenamiento
            trainingData = {
                accuracy: [],
                loss: [],
                val_accuracy: [],
                val_loss: []
            };
            
            // Reiniciar los gráficos
            window.accuracyChart.updateSeries([{
                name: 'Precisión de Entrenamiento',
                data: []
            }, {
                name: 'Precisión de Validación',
                data: []
            }]);
            
            window.lossChart.updateSeries([{
                name: 'Pérdida de Entrenamiento',
                data: []
            }, {
                name: 'Pérdida de Validación',
                data: []
            }]);
            
            // Iniciar el stream de datos reales
            iniciarStream();
        }

        // Función para detener entrenamiento
        function stopTraining() {
            if (trainingInProgress) {
                trainingInProgress = false;
                
                // Cerrar la conexión SSE
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                
                if (confirm('¿Desea detener el entrenamiento? El progreso actual se guardará.')) {
                    // Finalizar entrenamiento anticipadamente
                    modelTrained = true;
                    trainingCompleted = true;
                    
                    // Habilitar inferencia
                    inferenceSection.style.display = 'block';
                    noModelMessage.style.display = 'none';
                    
                    alert('Entrenamiento detenido. El modelo está listo para inferencia.');
                    
                    // Hacer una solicitud al servidor para detener el entrenamiento
                    fetch('/stop-training', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Entrenamiento detenido en el servidor:', data);
                    })
                    .catch(error => {
                        console.error('Error al detener el entrenamiento:', error);
                    });
                } else {
                    // Continuar entrenamiento
                    trainingInProgress = true;
                    iniciarStream(); // Reiniciar el stream
                }
            }
        }

        // Función para actualizar los gráficos con datos reales
        function updateCharts() {
            // Crear arrays de categorías (épocas)
            const categories = Array.from({length: currentEpoch}, (_, i) => i + 1);
            
            // Actualizar gráfico de precisión
            window.accuracyChart.updateOptions({
                xaxis: {
                    categories: categories
                }
            });
            
            window.accuracyChart.updateSeries([{
                name: 'Precisión de Entrenamiento',
                data: trainingData.accuracy
            }, {
                name: 'Precisión de Validación',
                data: trainingData.val_accuracy
            }]);
            
            // Actualizar gráfico de pérdida
            window.lossChart.updateOptions({
                xaxis: {
                    categories: categories
                }
            });
            
            window.lossChart.updateSeries([{
                name: 'Pérdida de Entrenamiento',
                data: trainingData.loss
            }, {
                name: 'Pérdida de Validación',
                data: trainingData.val_loss
            }]);
        }

        // Función para actualizar la barra de progreso
        function updateTrainingProgress() {
            const progress = (currentEpoch / totalEpochs) * 100;
            trainingProgress.style.width = progress + '%';
            progressText.textContent = `Época ${currentEpoch}/${totalEpochs} - ${Math.round(progress)}%`;
            
            // Actualizar métricas en la UI
            if (trainingData.accuracy.length > 0 && currentEpoch > 0) {
                const lastIndex = currentEpoch - 1;
                document.getElementById('train-accuracy').textContent = 
                    (trainingData.accuracy[lastIndex] * 100).toFixed(2) + '%';
                document.getElementById('train-loss').textContent = 
                    trainingData.loss[lastIndex].toFixed(3);
                document.getElementById('val-accuracy').textContent = 
                    (trainingData.val_accuracy[lastIndex] * 100).toFixed(2) + '%';
                document.getElementById('val-loss').textContent = 
                    trainingData.val_loss[lastIndex].toFixed(3);
            }
        }

        // Función para ejecutar inferencia
        function runInference() {
            if (!modelTrained) {
                alert('Por favor, entrene un modelo primero.');
                return;
            }
            
            if (!inferenceUpload.files.length) {
                alert('Por favor, cargue datos para la inferencia.');
                return;
            }
            
            // Mostrar que se está procesando
            const inferenceOutput = document.getElementById('inference-output');
            inferenceOutput.innerHTML = '<div style="text-align: center; padding: 20px;">Procesando...</div>';
            
            // Enviar el archivo al servidor para inferencia
            const formData = new FormData();
            formData.append('file', inferenceUpload.files[0]);
            
            fetch('/run-inference', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Resultados de la inferencia:', data);
                // // Actualizar métricas con datos reales
                // document.getElementById('test-accuracy').textContent = (data.accuracy * 100).toFixed(2) + '%';
                // document.getElementById('test-recall').textContent = (data.recall * 100).toFixed(2) + '%';
                // document.getElementById('test-f1').textContent = data.f1.toFixed(3);
                // document.getElementById('inference-time').textContent = data.inference_time + ' ms';
                
                // // Mostrar resultados reales
                // let resultsHTML = '<h4>Resultados de la Inferencia:</h4>';
                
                // // Generar resultados según el tipo de modelo
                // const modelType = document.getElementById('model-select').value.split('-')[0];
                
                // if (data.predictions && data.predictions.length > 0) {
                //     if (modelType === 'image') {
                //         // Modelos de clasificación de imágenes
                //         resultsHTML += `
                //             <div style="margin-top: 15px;">
                //                 <table style="width: 100%; border-collapse: collapse;">
                //                     <tr style="background-color: #f2f2f2;">
                //                         <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Clase</th>
                //                         <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Confianza</th>
                //                     </tr>
                //         `;
                        
                //         data.predictions.forEach(pred => {
                //             resultsHTML += `
                //                 <tr>
                //                     <td style="padding: 8px; border: 1px solid #ddd;">${pred.class}</td>
                //                     <td style="padding: 8px; border: 1px solid #ddd;">${pred.confidence.toFixed(2)}</td>
                //                 </tr>
                //             `;
                //         });
                        
                //         resultsHTML += `</table></div>`;
                //     } else if (modelType === 'text') {
                //         // Modelos de procesamiento de lenguaje natural
                //         resultsHTML += `
                //             <div style="margin-top: 15px;">
                //                 <p><strong>Texto analizado:</strong> "${data.input_text || 'Texto de ejemplo'}"</p>
                //                 <p><strong>Sentimiento:</strong> ${data.sentiment || 'N/A'} (${(data.sentiment_confidence || 0).toFixed(2)} confianza)</p>
                //         `;
                        
                //         if (data.entities && data.entities.length > 0) {
                //             resultsHTML += `<p><strong>Entidades detectadas:</strong></p><ul>`;
                //             data.entities.forEach(entity => {
                //                 resultsHTML += `<li>${entity.text} (${entity.type})</li>`;
                //             });
                //             resultsHTML += `</ul>`;
                //         }
                        
                //         resultsHTML += `</div>`;
                //     } else if (modelType === 'audio') {
                //         // Modelos de audio
                //         resultsHTML += `
                //             <div style="margin-top: 15px;">
                //                 <p><strong>Audio analizado:</strong> "${data.filename || 'audio_sample.wav'}" (duración: ${data.duration || '0'}s)</p>
                //                 <p><strong>Transcripción:</strong> "${data.transcription || 'N/A'}"</p>
                //                 <p><strong>Confianza de transcripción:</strong> ${(data.transcription_confidence || 0).toFixed(2)}</p>
                //         `;
                        
                //         if (data.features && data.features.length > 0) {
                //             resultsHTML += `<p><strong>Características detectadas:</strong></p><ul>`;
                //             data.features.forEach(feature => {
                //                 resultsHTML += `<li>${feature.name} (${feature.confidence.toFixed(2)} confianza)</li>`;
                //             });
                //             resultsHTML += `</ul>`;
                //         }
                        
                //         resultsHTML += `</div>`;
                //     } else if (modelType === 'video') {
                //         // Modelos de video
                //         resultsHTML += `
                //             <div style="margin-top: 15px;">
                //                 <p><strong>Video analizado:</strong> "${data.filename || 'video_sample.mp4'}" (duración: ${data.duration || '0'}s)</p>
                //                 <p><strong>Acción detectada:</strong> ${data.action || 'N/A'} (${(data.action_confidence || 0).toFixed(2)} confianza)</p>
                //         `;
                        
                //         if (data.objects && data.objects.length > 0) {
                //             resultsHTML += `<p><strong>Objetos detectados:</strong></p><ul>`;
                //             data.objects.forEach(obj => {
                //                 resultsHTML += `<li>${obj.name} (${obj.confidence.toFixed(2)} confianza)</li>`;
                //             });
                //             resultsHTML += `</ul>`;
                //         }
                        
                //         resultsHTML += `</div>`;
                //     }
                // } else {
                //     // Modelo genérico o sin predicciones específicas
                //     resultsHTML += `
                //         <div style="margin-top: 15px;">
                //             <p>Se procesaron ${data.samples_processed || 0} muestras con éxito.</p>
                //             <p>Tiempo promedio de procesamiento por muestra: ${data.avg_processing_time || 0} ms</p>
                //             <p>Precisión global: ${(data.accuracy * 100).toFixed(2)}%</p>
                //         </div>
                //     `;
                // }
                
                // inferenceOutput.innerHTML = resultsHTML;
            })
            .catch(error => {
                console.error('Error en inferencia:', error);
                inferenceOutput.innerHTML = `<div style="text-align: center; padding: 20px; color: red;">Error al procesar la inferencia: ${error.message}</div>`;
            });
        }

        // Función para enviar opciones al servidor
        async function sendOptions() {
            const model = document.getElementById('model-select').value;
            const dataSource = document.querySelector('input[name="data-source"]:checked').value;
            const dataset = dataSource === 'server' ? document.getElementById('server-dataset').value : null;
            const format = dataSource === 'upload' ? document.getElementById('dataset-format').value : null;
            const fileInput = document.getElementById('dataset-upload');
            const file = fileInput && fileInput.files.length > 0 ? fileInput.files[0] : null;
            const porcentajeDataset = document.getElementById('porcentaje-dataset').value;
            const batchSize = document.getElementById('batch-size').value;
            const epochs = document.getElementById('epochs').value;
            const optimizer = document.getElementById('optimizer').value;
            const learningRate = document.getElementById('learning-rate').value;
            const validationSplit = document.getElementById('validation-split').value;
            const earlyStopping = document.getElementById('early-stopping').value;
            const enableAug = document.getElementById('enable-augmentation').checked;
            const augmentation = enableAug ? {
                    flip: document.getElementById('aug-flip').checked,
                    rotation: document.getElementById('aug-rotation').checked,
                    zoom: document.getElementById('aug-zoom').checked,
                    brightness: document.getElementById('aug-brightness').checked,
                    contrast: document.getElementById('aug-contrast').checked,
                    shift: document.getElementById('aug-shift').checked
                } : null;
            
            const formData = new FormData();
            formData.append('model', model);
            formData.append('dataSource', dataSource);
            formData.append('dataset', dataset || '');
            formData.append('format', format || '');
            formData.append('porcentajeDataset', porcentajeDataset);
            formData.append('batchSize', batchSize);
            formData.append('epochs', epochs);
            formData.append('optimizer', optimizer);
            formData.append('learningRate', learningRate);
            formData.append('validationSplit', validationSplit);
            formData.append('earlyStopping', earlyStopping);
            formData.append('enableAug', enableAug);

            if (augmentation) {
                formData.append('augmentation', JSON.stringify(augmentation)); 
            }

            if (file) {
                formData.append('file', file);
            }

            try {
                const response = await fetch('model-params', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Respuesta del servidor:', result);
                
                // Iniciar entrenamiento después de enviar los parámetros
                startTraining();
            } catch (error) {
                console.error('Error al enviar datos:', error);
                alert('Error al iniciar el entrenamiento');
            }
        }

        // Función para iniciar el stream de datos de entrenamiento
        function iniciarStream() {
            if (eventSource) {
                eventSource.close(); // Cerrar conexión existente si la hay
                eventSource = null;
            }

            eventSource = new EventSource("http://localhost:8080/stream-metrics");
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log("Epoch:", data.epoch, "Accuracy:", data.train_accuracy);
                
                // Actualizar el contador de épocas
                currentEpoch = data.epoch;
                
                // Almacenar los datos de entrenamiento
                trainingData.accuracy.push(data.train_accuracy);
                trainingData.loss.push(data.train_loss);
                trainingData.val_accuracy.push(data.val_accuracy);
                trainingData.val_loss.push(data.val_loss);
                
                // Actualizar gráficos y progreso
                updateCharts();
                updateTrainingProgress();
                
                // Verificar si el entrenamiento ha terminado
                if (data.test_accuracy !== undefined || currentEpoch >= totalEpochs) {
                    // Entrenamiento completado
                    trainingInProgress = false;
                    modelTrained = true;
                    trainingCompleted = true;
                    
                    // Cerrar la conexión
                    eventSource.close();
                    eventSource = null;
                    
                    // Habilitar inferencia
                    inferenceSection.style.display = 'block';
                    noModelMessage.style.display = 'none';
                    
                    if (data.test_accuracy !== undefined) {
                        // Actualizar las métricas finales de prueba
                        document.getElementById('test-accuracy').textContent = (data.test_accuracy * 100).toFixed(2) + '%';
                        document.getElementById('test-recall').textContent = (data.test_recall || 0 * 100).toFixed(2) + '%';
                        document.getElementById('test-f1').textContent = (data.test_f1 || 0).toFixed(3);
                        for (let i = 0; i < trainingData.accuracy.length; i++) {
                            metrics.push({
                                epoch: i + 1,
                                train_accuracy: trainingData.accuracy[i],
                                train_loss: trainingData.loss[i],
                                val_accuracy: trainingData.val_accuracy[i],
                                val_loss: trainingData.val_loss[i]
                            });
                        }
                    }
                    
                    // Notificar al usuario
                    //alert('¡Entrenamiento completado! El modelo está listo para inferencia.');
                }
               

            };

            eventSource.onerror = function(err) {
                console.error("Error en el stream:", err);
                // Cerrar la conexión en caso de error
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                
                // Si el entrenamiento estaba en progreso, informar al usuario
                if (trainingInProgress) {
                    trainingInProgress = false;
                    alert('Error en la conexión con el servidor. Por favor, intente nuevamente.');
                }
            };
        }
        

        function downloadJSON(data, filename = 'metrics.json') {
            console.log(metrics);
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        function downloadCSV(data, filename = 'metrics.csv') {
            const header = Object.keys(data[0]).join(",");
            const rows = data.map(row => Object.values(row).join(",")).join("\n");
            const csv = `${header}\n${rows}`;

            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        function downloadChartImage(chartId = 'accuracy') {
            let chart;

            if (chartId === 'accuracy') {
                chart = window.accuracyChart;
            } else if (chartId === 'loss') {
                chart = window.lossChart;
            } else {
                console.error("ID de gráfico inválido");
                return;
            }

            chart.dataURI().then(({ imgURI, blob }) => {
                const link = document.createElement("a");
                link.href = imgURI;
                link.download = `${chartId}-chart.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }




    </script>
</body>
</html>
